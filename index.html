<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hello Kitty Cafe World</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&family=Nunito:wght@700;800&display=swap');

:root {
    --bg-color: #fce6ed;       
    --dot-color: #f8bfd2;       
    --card-bg: #fff6f6;
    --border-color: #e5cfe1;    
    --pink-pastel: #FFB7D5;
    --blue-pastel: #BAE1FF;
    --yellow-pastel: #2c2a21;
    --text-main: #8E7C85;      
    --text-light: #B4A5AC;
}

body {
    margin: 0;
    font-family: 'Quicksand', sans-serif;
    color: var(--text-main);
    background-color: var(--bg-color);
    overflow-x: hidden;
    background-image: radial-gradient(var(--dot-color) 3px, transparent 3px);
    background-size: 80px 80px; 
    background-position: 0 0;
}

.nav-bar, 
.profile-header, 
.market-item, 
.gacha-card, 
.info-card,
.start-btn,
.promo-input,
.auction-modal {
    background: var(--card-bg);
    border: 2px solid var(--border-color);
    border-radius: 20px;
    box-shadow: 0 4px 0 #F0F0F0;
}

button {
    border: none;
    cursor: pointer;
    font-family: 'Nunito', sans-serif;
    font-weight: 800;
    transition: transform 0.1s;
}

button:active {
    transform: translateY(2px);
    box-shadow: none !important; 
}

.start-btn, .btn-claim, .connect-mm, #donate-button, .bid-btn {
    background-color: var(--pink-pastel);
    color: white;
    border: none;
    box-shadow: 0 4px 0 #FF9ECA; 
}

.buy-btn, .promo-btn, .sell-btn {
    background-color: var(--blue-pastel);
    color: white;
    border-radius: 12px;
    box-shadow: 0 3px 0 #90CAF9;
}

.skip-btn, .cancel-btn {
    background: white;
    color: var(--text-main);
    border: 2px solid var(--border-color);
    box-shadow: 0 3px 0 #E0E0E0;
}

#start-screen {
    position: fixed;
    inset: 0;
    background-color: var(--bg-color);
    background-image: radial-gradient(var(--dot-color) 2px, transparent 2px);
    background-size: 60px 60px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.start-btn {
    margin-top: 20px;
    padding: 16px 50px;
    font-size: 22px;
    border-radius: 50px;
}

h1 {
    font-family: 'Nunito', sans-serif;
    color: var(--pink-pastel);
    font-size: 30px;
    font-weight: 800;
    margin-bottom: 5px;
}

.nav-bar {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    padding: 8px 30px;
    border-radius: 50px;
    display: flex;
    gap: 30px;
    z-index: 100;
    border: none;
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
}

.nav-item {
    font-size: 26px;
    cursor: pointer;
    opacity: 0.5;
    transition: 0.2s;
}

.nav-item.active {
    opacity: 1;
    transform: translateY(-2px);
}

.page {
    display: none;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    padding-bottom: 100px;
    max-width: 600px;
    width: 100%;
    margin: 0 auto;
    box-sizing: border-box;
}

.page.active {
    display: flex;
    animation: fadeIn 0.3s ease-out;
}

.gacha-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr); 
    gap: 12px;
    width: 100%;
    margin-top: 20px;
}

.gacha-card {
    width: auto; 
    padding: 15px 5px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.1s;
}

.gacha-card:hover {
    transform: translateY(-3px);
}

.gacha-card h3 {
    font-size: 14px;
    margin: 5px 0;
}

.gacha-card div:first-child {
    font-size: 40px !important; 
}

.price-tag {
    background: var(--bg-color);
    color: var(--text-main);
    padding: 4px 10px;
    border-radius: 8px;
    font-weight: 700;
    font-size: 12px;
    margin-top: 5px;
    border: 1px solid var(--border-color);
}

.market-list {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.market-item {
    padding: 15px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.profile-header {
    width: 100%;
    padding: 20px;
    box-sizing: border-box;
    text-align: center;
}

.promo-input {
    border: 2px solid var(--border-color);
    background: #FFFEFD;
    padding: 10px;
    outline: none;
    color: var(--text-main);
    box-shadow: inset 0 2px 0 #F0F0F0; 
    width: 100px;
    text-align: center;
}

#reward-overlay {
    position: fixed;
    inset: 0;
    display: none;
    background: rgba(255, 255, 255, 0.95);
    z-index: 600;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.drop-box {
    width: 220px;
    height: 220px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: radial-gradient(circle, #FFF0F5 0%, transparent 60%);
    margin-bottom: 20px;
}

.info-card {
    padding: 20px 40px;
    text-align: center;
    border: 2px solid var(--pink-pastel);
    box-shadow: 0 4px 0 var(--pink-pastel);
}

.btn-claim {
    margin-top: 25px;
    padding: 12px 40px;
    border-radius: 30px;
    font-size: 18px;
}

#video-layer {
    position: fixed;
    inset: 0;
    background: #000; 
    display: none;
    z-index: 500;
    justify-content: center;
    align-items: center;
}
video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 0;
    max-width: none;
}
.skip-btn {
    position: absolute;
    top: 40px; right: 20px;
    padding: 8px 20px;
    border-radius: 20px;
    font-weight: 700;
    z-index: 501;
}

#cafes-row {
    display: flex;
    gap: 12px;
    margin-top: 30px;
    justify-content: space-between; 
}

.donate-card {
    flex: 1; 
    min-width: 0;
    background: var(--card-bg);
    border: 2px solid var(--border-color);
    border-radius: 20px;
    box-shadow: 0 4px 0 #F0F0F0;
    padding: 12px 15px;
    cursor: pointer;
    transition: transform 0.1s, box-shadow 0.1s, border-color 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.donate-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 0 #F0F0F0;
}

.donate-card.selected {
    border-color: var(--pink-pastel);
    box-shadow: 0 6px 0 var(--pink-pastel);
}

.donate-card h2 {
    margin:0 0 5px 0;
    color: var(--pink-pastel);
    font-size:18px;
    font-weight:800;
}

.progress-bar {
    width: 100%;
    height: 10px;
    background: #F0F0F0;
    border-radius: 8px;
    overflow: hidden;
    margin:5px 0;
}

.progress-fill {
    height: 100%;
    background: var(--pink-pastel);
    width: 0%;
    transition: width 0.3s;
}

.donate-card p {
    font-size: 14px;
    margin: 2px 0;
    text-align: center;
}

#inventory {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
}

#auction-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 800;
    display: none;
    align-items: center;
    justify-content: center;
}

.auction-modal {
    width: 90%;
    max-width: 400px;
    padding: 20px;
    background: var(--bg-color);
    text-align: center;
}

.auction-log {
    height: 150px;
    overflow-y: auto;
    background: white;
    border: 2px solid var(--border-color);
    margin: 15px 0;
    padding: 10px;
    border-radius: 10px;
    font-size: 14px;
    text-align: left;
}

.log-entry { margin-bottom: 5px; }
.log-rival { color: #E53E3E; }
.log-user { color: #3182CE; font-weight: bold; }

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
</head>
<body>

    <audio id="bg-music" loop>
        <source src="music.mp3" type="audio/mpeg">
    </audio>

    <div id="start-screen" onclick="startGame()">
        <h1>üéÄ Hello Kitty World üéÄ</h1>
        <button class="start-btn">TAP TO START üéµ</button>
    </div>

    <div id="video-layer">
        <button class="skip-btn" onclick="skipVideo()">SKIP >></button>
        <video id="gacha-video" playsinline></video>
    </div>

    <div id="reward-overlay">
        <div class="reward-title">‚ú® YOU GOT IT! ‚ú®</div>
        <div class="drop-box">
            <div class="glow-aura" id="glow-fx"></div>
            <img id="reward-img" src="" class="drop-img">
        </div>
        <div class="info-card">
            <h2 id="reward-name" style="margin: 0; color: var(--primary);">Name</h2>
            <p id="reward-rarity" style="margin: 5px 0 0 0; color: #888; font-weight: bold;">RARITY</p>
        </div>
        <button class="btn-claim" onclick="claimReward()">KEEP IT! üíñ</button>
    </div>

    <div id="auction-overlay">
        <div class="auction-modal">
            <h2 id="auction-title">Auction</h2>
            <img id="auction-img" src="" style="width:80px;height:80px;object-fit:contain;margin-bottom:10px;">
            <p>Current Bid: <span id="auction-price">0</span> ETH</p>
            <div class="auction-log" id="auction-log"></div>
            <div id="auction-controls">
                <button class="bid-btn" onclick="placeBid()">BID HIGHER (+0.1)</button>
                <button class="cancel-btn" onclick="closeAuction()">EXIT</button>
            </div>
            <div id="auction-status" style="margin-top:10px; font-weight:bold; color:var(--pink-pastel);"></div>
        </div>
    </div>

    <div id="main-ui" style="display: none;">
        <nav class="nav-bar">
            <div class="nav-item active" onclick="setPage('gacha')">üé∞</div>
            <div class="nav-item" onclick="setPage('market')">üè™</div>
            <div class="nav-item" onclick="setPage('donate')">üíñ</div>
            <div class="nav-item" onclick="setPage('profile')">üë§</div>
        </nav>

        <div id="page-gacha" class="page active">
            <h1>Choose a Treat!</h1>
            <div style="background: white; padding: 10px 30px; border-radius: 30px; margin-bottom: 20px; box-shadow: 0 5px 10px rgba(0,0,0,0.05);">
                <span style="color: var(--primary); font-weight: bold; font-size: 20px;">ü™ô <span id="ui-tokens">0</span> Tokens</span>
            </div>

            <div class="gacha-container">
                <div class="gacha-card" onclick="spin('icecream', 25)">
                    <div style="font-size: 60px;">üç¶</div>
                    <h3>Ice Cream</h3>
                    <div class="price-tag">25 TKN</div>
                </div>
                <div class="gacha-card" onclick="spin('milkshake', 50)">
                    <div style="font-size: 60px;">ü•§</div>
                    <h3>Milkshake</h3>
                    <div class="price-tag">50 TKN</div>
                </div>
                <div class="gacha-card" onclick="spin('cake', 100)">
                    <div style="font-size: 60px;">üéÇ</div>
                    <h3>Cake</h3>
                    <div class="price-tag">100 TKN</div>
                </div>
            </div>
        </div>

        <div id="page-market" class="page">
            <h1>üè™ Market</h1>
            <p>Bid against rivals to win items!</p>
            <div id="market-container" class="market-list"></div>
        </div>

        <div id="page-donate" class="page">
            <h1>Support Cafes ‚òï</h1>
            <div style="margin-top:10px; font-size:16px; color: var(--text-main);">
                üíñ 1 ETH = 1000 Tokens (+ Bonus)
            </div>
            <div style="margin-top:15px;">
                <input type="number" id="donate-input" class="promo-input" placeholder="0.1 ETH" style="width:150px; font-size:18px;">
                <button class="connect-mm" style="margin-left:10px;" onclick="donate()">DONATE</button>
            </div>
            <div id="cafes-row" style="display:flex; gap:12px; margin-top:30px; justify-content: space-between;">
                <div class="donate-card" data-index="0" onclick="selectCafe(0)">
                    <h2>Kitty Cafe</h2>
                    <p>Goal: 10 ETH | Collected: <span class="collected">0</span> ETH</p>
                    <div class="progress-bar"><div class="progress-fill" style="width:0%"></div></div>
                    <p>Reward: <span class="multiplier">1.23√ó</span></p>
                </div>
                <div class="donate-card" data-index="1" onclick="selectCafe(1)">
                    <h2>Hello Cafe</h2>
                    <p>Goal: 8 ETH | Collected: <span class="collected">0</span> ETH</p>
                    <div class="progress-bar"><div class="progress-fill" style="width:0%"></div></div>
                    <p>Reward: <span class="multiplier">1.84√ó</span></p>
                </div>
                <div class="donate-card" data-index="2" onclick="selectCafe(2)">
                    <h2>Rainbow Cafe</h2>
                    <p>Goal: 5 ETH | Collected: <span class="collected">0</span> ETH</p>
                    <div class="progress-bar"><div class="progress-fill" style="width:0%"></div></div>
                    <p>Reward: <span class="multiplier">2.17√ó</span></p>
                </div>
            </div>
        </div>

        <div id="page-profile" class="page">
            <h1>My Profile üë§</h1>
            <div class="profile-header">
                <button class="connect-mm" onclick="connectWallet()">ü¶ä Connect MetaMask</button>
                <p id="wallet-address" style="font-size: 12px; display: none;">0x...</p>
                <div style="display: flex; justify-content: space-around; margin-top: 15px;">
                    <div><b>ETH:</b> <span id="ui-eth">0.00</span></div>
                    <div><b>TKN:</b> <span id="ui-tokens-p">0</span></div>
                </div>
                <div class="promo-area">
                    <p style="font-size: 12px; margin-bottom: 5px;">Secret Code:</p>
                    <div class="promo-container">
                        <input type="text" id="promo-code" class="promo-input" placeholder="Enter code">
                        <button class="promo-btn" onclick="applyPromo()">APPLY</button>
                    </div>
                    <div id="promo-status" class="promo-status">‚ú® Code Activated! ‚ú®</div>
                </div>
            </div>
            <h3>My Inventory</h3>
            <p style="font-size:12px; margin-bottom:10px;">Click 'SELL' to start auction</p>
            <div id="inventory" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;"></div>
        </div>
    </div>

    <script>
        const TOKEN_ADDRESS = "0x4ed7c70F96B99c776995fB64377f0d4aB3B0e1C1"; 
        const NFT_ADDRESS = "0x322813Fd9A801c5507c9de605d63CEA4f2CE6c44"; 
        const CF_ADDRESS = "0xa85233C63b9Ee964Add6F2cffe00Fd84eb32338f";

        const TOKEN_ABI = [
            "function balanceOf(address) view returns (uint256)", 
            "function decimals() view returns (uint8)", 
            "function burn(uint256 amount) external",
            "function mint(address to, uint256 amount) external" 
        ];
        
        const CF_ABI = ["function contribute(uint256 _id) public payable", "function campaignCount() public view returns (uint256)", "function createCampaign(string,uint256,uint256) public"];
        const NFT_ABI = ["function mintItem(address player, string memory tokenURI) public returns (uint256)"];

        let provider, signer, tokenContract, cfContract, nftContract;
        let userAddress = "";
        let tokens = 0;
        let eth = 0;
        let virtualEth = 0; 
        let currentReward = null;
        let promoActive = null;
        let inventory = []; 
        let marketItems = [];
        let autoSellTimer = null;

        const rivals = ["Bako_China", "Bezhevaya_Dana", "Moldir_Hristinka"];
        const prices = {
            common: 0.5,
            rare: 1.1,
            epic: 3.0,
            legendary: 7.0,
            mythic: 20.0
        };

        const rarities = {
            common: { color: "#a0aec0", name: "Common" },
            rare: { color: "#63b3ed", name: "Rare" },
            epic: { color: "#9f7aea", name: "Epic" },
            legendary: { color: "#f6e05e", name: "Legendary" },
            mythic: { color: "#f56565", name: "MYTHIC" }
        };

        const cafes = [
            { name: "Kitty Cafe", goal: 10, collected: 0, multiplier: 1.23 },
            { name: "Hello Cafe", goal: 8, collected: 0, multiplier: 1.84 },
            { name: "Rainbow Cafe", goal: 5, collected: 0, multiplier: 2.17 }
        ];

        let selectedCafe = 0;
        
        let auctionState = {
            active: false,
            item: null,
            type: 'buy', 
            currentBid: 0,
            userWins: 0,
            turn: 0
        };

        const music = document.getElementById('bg-music');
        music.volume = 0.2;

        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('main-ui').style.display = 'block';
            music.play();
            generateMarket();
            renderMarket();
        }

        function setPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('page-' + id).classList.add('active');
            
            const map = ['gacha', 'market', 'donate', 'profile'];
            const index = map.indexOf(id);
            if(index !== -1) document.querySelectorAll('.nav-item')[index].classList.add('active');

            if(id === 'profile') renderInventory();
        }
        
        async function connectWallet() {
            if (window.ethereum) {
                try {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();
                    
                    tokenContract = new ethers.Contract(TOKEN_ADDRESS, TOKEN_ABI, signer);
                    cfContract = new ethers.Contract(CF_ADDRESS, CF_ABI, signer);
                    nftContract = new ethers.Contract(NFT_ADDRESS, NFT_ABI, signer);

                    document.getElementById('wallet-address').innerText = userAddress.substring(0,6) + "..." + userAddress.substring(38);
                    document.getElementById('wallet-address').style.display = 'block';
                    document.querySelector('#page-profile .connect-mm').innerText = "Connected ‚úÖ";

                    const savedV = localStorage.getItem('kitty_veth_' + userAddress.toLowerCase());
                    virtualEth = savedV ? parseFloat(savedV) : 0;

                    await updateBalances();
                    await checkAndCreateInitialCampaign();

                    const savedInv = localStorage.getItem('kitty_inv_' + userAddress.toLowerCase());
                    inventory = savedInv ? JSON.parse(savedInv) : [];
                    renderInventory();

                } catch (e) { console.error(e); alert("Connect error!"); }
            } else { alert("Install MetaMask!"); }
        }

        async function updateBalances() {
            if (!userAddress || !tokenContract) return;
            try {
                const b = await provider.getBalance(userAddress);
                const realEth = parseFloat(ethers.utils.formatEther(b));
                eth = realEth + virtualEth;
                document.getElementById('ui-eth').innerText = eth.toFixed(2);
                
                const tb = await tokenContract.balanceOf(userAddress);
                tokens = Math.floor(parseFloat(ethers.utils.formatUnits(tb, 18)));
                document.querySelectorAll('#ui-tokens, #ui-tokens-p').forEach(el => el.innerText = tokens);
            } catch(e) { console.error(e); }
        }

        function selectCafe(index) {
            selectedCafe = index;
            document.querySelectorAll('.donate-card').forEach((card,i)=>{
                if(i === index) card.classList.add('selected');
                else card.classList.remove('selected');
            });
        }

        async function checkAndCreateInitialCampaign() {
            try {
                const countBN = await cfContract.campaignCount();
                const count = parseInt(countBN.toString());
                
                for (let i = count; i < cafes.length; i++) {
                    const tx = await cfContract.createCampaign(
                        cafes[i].name, 
                        ethers.utils.parseEther(cafes[i].goal.toString()), 
                        30
                    );
                    await tx.wait(); 
                }
            } catch (e) { console.log("Campaign check error", e); }
        }

        async function donate() {
            if (!cfContract || !userAddress) return alert("Connect Wallet first!");
            const val = parseFloat(document.getElementById('donate-input').value);
            if (!val || val <= 0) return alert("Enter amount!");

            const cafe = cafes[selectedCafe];
            
            let activeMultiplier = cafe.multiplier;
            if (cafe.collected >= cafe.goal) {
                activeMultiplier = 1.0;
            }

            try {
                const tx = await cfContract.contribute(selectedCafe, { value: ethers.utils.parseEther(val.toString()) });
                alert(`Donating to ${cafe.name}... Please wait.`);
                await tx.wait();

                const baseReward = val * 1000;
                const totalTargetReward = baseReward * activeMultiplier;
                const bonusNeeded = totalTargetReward - baseReward;

                if (bonusNeeded > 0) {
                    alert(`Base reward received! Now minting BONUS tokens (${bonusNeeded.toFixed(0)}) for multiplier ${activeMultiplier}x... Confirm transaction.`);
                    const bonusWei = ethers.utils.parseUnits(Math.floor(bonusNeeded).toString(), 18);
                    const txBonus = await tokenContract.mint(userAddress, bonusWei);
                    await txBonus.wait();
                }

                cafe.collected += val;
                
                if (cafe.collected >= cafe.goal && cafe.multiplier > 1.0) {
                    cafe.multiplier = 1.0;
                    alert(`üéâ Goal reached! Multiplier reset to 1x.`);
                } else {
                    alert(`Success! You received total: ${Math.floor(totalTargetReward)} Tokens!`);
                }

                renderCafeProgress();
                await updateBalances();

            } catch (e) { 
                console.error(e); 
                alert("Transaction failed! (Check console)"); 
            }
        }

        function renderCafeProgress() {
            document.querySelectorAll('.donate-card').forEach((card,i)=>{
                const cafe = cafes[i];
                card.querySelector('.collected').innerText = cafe.collected.toFixed(2);
                const percent = Math.min((cafe.collected/cafe.goal)*100, 100);
                
                const fill = card.querySelector('.progress-fill');
                fill.style.width = percent+'%';
                
                if (cafe.collected >= cafe.goal) {
                    fill.style.background = '#4CAF50';
                    card.querySelector('.multiplier').innerText = "1.00√ó (Goal Reached)";
                } else {
                    card.querySelector('.multiplier').innerText = cafe.multiplier.toFixed(2)+'√ó';
                }
            });
        }

        selectCafe(0);
        renderCafeProgress();

        function generateMarket() {
            marketItems = [];
            const types = ['icecream', 'milkshake', 'cake'];
            const rList = ['common', 'common', 'rare', 'rare', 'epic', 'legendary'];
            
            for(let i=0; i<6; i++) {
                const type = types[Math.floor(Math.random()*types.length)];
                const rar = rList[Math.floor(Math.random()*rList.length)];
                marketItems.push({
                    type: type,
                    name: type.toUpperCase(),
                    rarity: rar,
                    image: `${type}_${rar}.png`,
                    price: prices[rar]
                });
            }
        }

        function renderMarket() {
            const box = document.getElementById('market-container');
            box.innerHTML = '';
            marketItems.forEach((item, idx) => {
                const color = rarities[item.rarity].color;
                box.innerHTML += `
                    <div class="market-item">
                        <div style="display:flex; align-items:center; gap:15px;">
                            <img src="${item.image}" style="width:60px; height:60px; border:2px solid ${color}; border-radius:10px;">
                            <div>
                                <h3 style="margin:0;">${item.name}</h3>
                                <div style="font-size:12px; color:${color}; font-weight:bold;">${item.rarity.toUpperCase()}</div>
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-weight:bold; margin-bottom:5px;">${item.price} ETH</div>
                            <button class="buy-btn" style="padding:5px 15px;" onclick="startAuction(${idx}, 'buy')">BID NOW</button>
                        </div>
                    </div>
                `;
            });
        }

        function startAuction(idx, type) {
            if(!userAddress) return alert("Connect Wallet first!");
            
            const item = type === 'buy' ? marketItems[idx] : inventory[idx];
            
            if (!item.price) {
                item.price = prices[item.rarity] || 0.5;
            }
            
            if(type === 'buy' && eth < item.price) return alert("Not enough ETH!");

            if(autoSellTimer) clearInterval(autoSellTimer);

            auctionState = {
                active: true,
                item: item,
                index: idx,
                type: type,
                currentBid: item.price,
                userWins: 0,
                turn: 0
            };

            document.getElementById('auction-overlay').style.display = 'flex';
            document.getElementById('auction-title').innerText = type === 'buy' ? "BUY AUCTION" : "SELL AUCTION";
            document.getElementById('auction-img').src = item.image;
            document.getElementById('auction-price').innerText = item.price.toFixed(2);
            document.getElementById('auction-log').innerHTML = `<div class="log-entry">Auction started at ${item.price.toFixed(2)} ETH</div>`;
            document.getElementById('auction-status').innerText = "";
            
            const btn = document.querySelector('#auction-controls .bid-btn');
            
            if(type === 'sell') {
                btn.style.display = 'none'; 
                autoPlaySellAuction(); 
            } else {
                btn.style.display = 'inline-block';
                btn.innerText = `BID ${(item.price + 0.1).toFixed(2)}`;
                btn.disabled = false;
            }
        }


        function placeBid() {
            if(auctionState.type !== 'buy') return;

            const bid = auctionState.currentBid + 0.1;
            auctionState.currentBid = bid;
            logAuction("You", bid);
            
            document.getElementById('auction-price').innerText = bid.toFixed(2);
            
            document.querySelector('.bid-btn').disabled = true;
            document.getElementById('auction-status').innerText = "Rival is thinking...";

            setTimeout(() => {
                const rival = rivals[Math.floor(Math.random()*rivals.length)];
                
                if (auctionState.userWins >= 2) { 
                    document.getElementById('auction-status').innerText = "‚ú® YOU WIN! ‚ú®";
                    setTimeout(() => finalizeAuction(true), 1000);
                } else {
                    const rivalBid = auctionState.currentBid + 0.15;
                    auctionState.currentBid = rivalBid;
                    logAuction(rival, rivalBid);
                    document.getElementById('auction-price').innerText = rivalBid.toFixed(2);
                    
                    auctionState.userWins++; 
                    document.querySelector('.bid-btn').innerText = `BID ${(rivalBid + 0.1).toFixed(2)}`;
                    document.querySelector('.bid-btn').disabled = false;
                    document.getElementById('auction-status').innerText = `Your Turn!`;
                }
            }, 1500);
        }

        function autoPlaySellAuction() {
            let rounds = 0;
            document.getElementById('auction-status').innerText = "Searching for buyers...";
            
            autoSellTimer = setInterval(() => {
                rounds++;
                const rival = rivals[rounds % 3];
                const bump = Math.random() * 0.5 + 0.1;
                auctionState.currentBid += bump;
                
                logAuction(rival, auctionState.currentBid);
                document.getElementById('auction-price').innerText = auctionState.currentBid.toFixed(2);
                
                if(rounds >= 3) {
                    clearInterval(autoSellTimer);
                    document.getElementById('auction-status').innerText = "SOLD! üí∞";
                    setTimeout(() => finalizeAuction(true), 1000);
                }
            }, 1500); 
        }

        async function finalizeAuction(success) {
            if(success) {
                if(auctionState.type === 'buy') {
                    try {
                        const tx = await signer.sendTransaction({
                            to: "0x6C82ce6b1b0D197Fc01788Fe0D680FBA40Ec7a57",
                            value: ethers.utils.parseEther(auctionState.currentBid.toFixed(4))
                        });
                        await tx.wait();

                        if (nftContract) {
                             await nftContract.mintItem(userAddress, auctionState.item.image);
                        }
                        inventory.push(auctionState.item);
                        alert(`Won! Paid ${auctionState.currentBid.toFixed(2)} ETH.`);
                    } catch(e) {
                        alert("Purchase cancelled or failed.");
                        closeAuction();
                        return;
                    }
                } else {
                    inventory.splice(auctionState.index, 1);
                    virtualEth += auctionState.currentBid;
                    localStorage.setItem('kitty_veth_' + userAddress.toLowerCase(), virtualEth.toString());
                    alert(`Sold for ${auctionState.currentBid.toFixed(2)} ETH!`);
                }
                localStorage.setItem('kitty_inv_' + userAddress.toLowerCase(), JSON.stringify(inventory));
                renderInventory();
                updateBalances();
            }
            closeAuction();
        }

        function logAuction(who, amount) {
            const box = document.getElementById('auction-log');
            const cls = who === 'You' ? 'log-user' : 'log-rival';
            box.innerHTML += `<div class="log-entry"><span class="${cls}">${who}</span> bid ${amount.toFixed(2)} ETH</div>`;
            box.scrollTop = box.scrollHeight;
        }

        function closeAuction() {
            if(autoSellTimer) clearInterval(autoSellTimer);
            autoSellTimer = null;
            document.getElementById('auction-overlay').style.display = 'none';
            document.getElementById('auction-log').innerHTML = '';
            document.getElementById('auction-status').innerText = '';
            auctionState.active = false;
            auctionState.userWins = 0;
            const btn = document.querySelector('.bid-btn');
            if(btn) btn.disabled = false;
        }

        function applyPromo() {
            const val = document.getElementById('promo-code').value.toUpperCase().trim();
            if (val === 'MIF' || val === 'LEG') {
                promoActive = val;
                document.getElementById('promo-status').innerText = `‚ú® ${val} ACTIVE ‚ú®`;
                document.getElementById('promo-status').style.display = 'block';
                document.getElementById('promo-status').style.color = 'green';
            } else { alert("Wrong code!"); }
        }

        async function spin(type, cost) {
            if (!tokenContract || !userAddress) return alert("Connect Wallet in Profile first!");
            if (tokens < cost) return alert("Not enough tokens! Donate ETH.");

            try {
                const amountToBurn = ethers.utils.parseUnits(cost.toString(), 18);
                const tx = await tokenContract.burn(amountToBurn);
                await tx.wait(); 
                await updateBalances();

                let rKey = 'common';
                const rand = Math.random() * 100;
                if (promoActive === 'MIF') rKey = 'mythic';
                else if (promoActive === 'LEG') rKey = 'legendary';
                else {
                    if(rand > 60) rKey = 'rare';
                    if(rand > 85) rKey = 'epic';
                    if(rand > 98) rKey = 'legendary';
                    if(rand > 99.8) rKey = 'mythic';
                }
                promoActive = null; 
                document.getElementById('promo-status').style.display = 'none';

                currentReward = { type: type, name: type.toUpperCase(), rarity: rKey, image: `${type}_${rKey}.png`, price: prices[rKey] };

                document.getElementById('main-ui').style.display = 'none';
                
                const vl = document.getElementById('video-layer');
                const v = document.getElementById('gacha-video');
                vl.style.display = 'flex'; 
                
                v.src = `${type}_spin.mp4`;
                v.play();
                v.onended = showReward;

            } catch (e) { alert("Transaction failed."); }
        }

        function skipVideo() {
            const v = document.getElementById('gacha-video');
            v.pause();
            showReward();
        }

        function showReward() {
            const overlay = document.getElementById('reward-overlay');
            const rData = rarities[currentReward.rarity];
            document.getElementById('reward-name').innerText = currentReward.name;
            document.getElementById('reward-rarity').innerText = rData.name;
            document.getElementById('reward-rarity').style.color = rData.color;
            document.getElementById('reward-img').src = currentReward.image;
            document.getElementById('glow-fx').style.background = `radial-gradient(circle, ${rData.color} 0%, transparent 70%)`;
            overlay.style.display = 'flex';
            setTimeout(() => overlay.classList.add('show'), 10);
        }

        async function claimReward() {
            inventory.push(currentReward);
            if(userAddress) {
                localStorage.setItem('kitty_inv_' + userAddress.toLowerCase(), JSON.stringify(inventory));
            }

            if (nftContract && userAddress) {
                try {
                    const tx = await nftContract.mintItem(userAddress, currentReward.image);
                } catch (e) { console.warn("NFT Mint failed"); }
            }

            renderInventory();
            document.getElementById('reward-overlay').classList.remove('show');
            setTimeout(() => {
                document.getElementById('reward-overlay').style.display = 'none';
                document.getElementById('video-layer').style.display = 'none';
                document.getElementById('main-ui').style.display = 'block';
                music.volume = 0.2;
            }, 300);
        }

        function renderInventory() {
            const box = document.getElementById('inventory');
            if(!box) return;
            box.innerHTML = "";
            
            if(!userAddress) {
                box.innerHTML = "<p>Connect wallet to see your collection üéÄ</p>";
                return;
            }

            inventory.forEach((item, idx) => {
                const color = rarities[item.rarity]?.color || "#ccc";
                box.innerHTML += `
                    <div style="width:100px; padding:5px; border:2px solid ${color}; border-radius:15px; background:white; display:flex; flex-direction:column; align-items:center; margin:5px;">
                        <img src="${item.image}" style="width:60px; height:60px; object-fit:contain;">
                        <div style="font-size:10px; font-weight:bold; color:${color}; margin:5px 0;">${item.rarity.toUpperCase()}</div>
                        <button class="sell-btn" style="width:100%; font-size:10px; padding:5px;" onclick="startAuction(${idx}, 'sell')">SELL</button>
                    </div>
                `;
            });
        }
    </script>
</body>
</html>