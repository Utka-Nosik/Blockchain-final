<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hello Kitty Cafe World</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        :root {
            --primary: #ff69b4;
            --soft-pink: #ffe6f0;
            --white: #ffffff;
            --glass: rgba(255, 255, 255, 0.85);
            --common: #a0aec0;
            --rare: #63b3ed;
            --epic: #9f7aea;
            --legendary: #f6e05e;
            --mythic: #f56565;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--soft-pink);
            background-image: radial-gradient(#ffb7d5 20%, transparent 20%);
            background-size: 50px 50px;
            font-family: 'Comic Sans MS', 'Arial', sans-serif;
            overflow: hidden;
            user-select: none;
            color: #555;
        }

        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--soft-pink);
            z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .start-btn {
            font-size: 30px; background: var(--primary); color: white;
            padding: 20px 60px; border-radius: 50px; border: 5px solid white;
            cursor: pointer; animation: pulse 1.5s infinite;
            font-family: inherit; font-weight: bold;
        }

        .nav-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--glass); padding: 15px 40px; border-radius: 50px;
            display: flex; gap: 30px; box-shadow: 0 10px 20px rgba(255,105,180,0.3); z-index: 100;
            border: 3px solid white; backdrop-filter: blur(5px);
        }
        .nav-item { font-size: 32px; cursor: pointer; transition: 0.2s; position: relative; }
        .nav-item:hover { transform: translateY(-5px) scale(1.1); }
        .nav-item.active::after {
            content: '‚óè'; color: var(--primary); font-size: 10px;
            position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%);
        }

        .page { display: none; height: 100vh; flex-direction: column; align-items: center; padding: 20px; box-sizing: border-box; overflow-y: auto; padding-bottom: 100px; }
        .page.active { display: flex; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h1 { color: var(--primary); text-shadow: 2px 2px 0 white; text-align: center; margin-bottom: 10px; }

        .gacha-container { display: flex; gap: 20px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        .gacha-card {
            background: white; border-radius: 25px; width: 200px; padding: 20px;
            text-align: center; cursor: pointer; transition: 0.3s;
            border: 4px solid var(--soft-pink); box-shadow: 0 8px 0 var(--soft-pink);
        }
        .gacha-card:hover { transform: translateY(-10px); border-color: var(--primary); box-shadow: 0 12px 0 #ff9ec6; }
        .gacha-card:active { transform: translateY(5px); box-shadow: 0 2px 0 #ff9ec6; }
        
        .price-tag { background: var(--primary); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; display: inline-block; margin-top: 10px; }

        .market-list {
            width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 15px;
        }
        .market-item {
            background: white; padding: 15px; border-radius: 20px; border: 3px solid var(--soft-pink);
            display: flex; align-items: center; justify-content: space-between;
        }
        .buy-btn {
            background: #48bb78; color: white; border: none; padding: 10px 20px;
            border-radius: 15px; cursor: pointer; font-weight: bold;
        }

        #video-layer {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 500;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        .skip-btn {
            position: absolute; top: 30px; right: 30px;
            background: white; color: var(--primary); border: 2px solid var(--primary);
            padding: 10px 30px; border-radius: 30px; font-weight: bold; font-family: inherit;
            cursor: pointer; z-index: 501; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .skip-btn:hover { background: var(--primary); color: white; }

        #reward-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 240, 245, 0.85); backdrop-filter: blur(8px);
            z-index: 600; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.5s;
        }
        #reward-overlay.show { opacity: 1; }

        .reward-title {
            font-size: 40px; color: var(--primary); text-shadow: 2px 2px 0 white;
            margin-bottom: 20px; animation: bounce 2s infinite;
        }

        .drop-box {
            position: relative; width: 400px; height: 400px;
            display: flex; align-items: center; justify-content: center;
        }
        .glow-aura {
            position: absolute; width: 100%; height: 100%; border-radius: 50%;
            background: radial-gradient(circle, gold 0%, transparent 70%);
            opacity: 0.5; animation: spinGlow 10s linear infinite; z-index: -1;
        }
        .drop-img { width: 250px; height: 250px; object-fit: contain; z-index: 2; animation: float 3s infinite ease-in-out; }

        .info-card {
            background: white; padding: 15px 40px; border-radius: 20px;
            border: 4px solid var(--primary); text-align: center; margin-top: -30px; z-index: 3;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .btn-claim {
            background: linear-gradient(to right, #f687b3, #ff69b4);
            color: white; border: none; padding: 15px 60px; font-size: 24px;
            border-radius: 50px; margin-top: 30px; cursor: pointer;
            box-shadow: 0 10px 20px rgba(255,105,180,0.4);
            border: 4px solid white; transition: 0.2s; font-family: inherit; font-weight: bold;
        }
        .btn-claim:hover { transform: scale(1.05); }

        .profile-header {
            background: white; width: 90%; max-width: 500px; padding: 20px;
            border-radius: 20px; text-align: center; border: 3px solid var(--soft-pink);
            margin-bottom: 20px;
        }
        .connect-mm {
            background: #f6ad55; color: white; border: none; padding: 10px 20px;
            border-radius: 20px; font-weight: bold; cursor: pointer; display: inline-block;
        }
        
        .promo-area { margin-top: 15px; border-top: 2px dashed #eee; padding-top: 10px; }
        .promo-container { display: flex; gap: 10px; justify-content: center; align-items: center; margin-top: 5px; }
        .promo-input {
            padding: 8px; border-radius: 10px; border: 2px solid var(--primary);
            text-align: center; width: 120px; font-family: inherit;
        }
        .promo-btn {
            background: var(--primary); color: white; border: none; padding: 8px 15px;
            border-radius: 10px; cursor: pointer; font-weight: bold; font-family: inherit;
        }
        .promo-status { font-size: 12px; color: green; display: none; margin-top: 5px; font-weight: bold; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        @keyframes spinGlow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <audio id="bg-music" loop>
        <source src="music.mp3" type="audio/mpeg">
    </audio>

    <div id="start-screen" onclick="startGame()">
        <h1>üéÄ Hello Kitty World üéÄ</h1>
        <button class="start-btn">TAP TO START üéµ</button>
    </div>

    <div id="video-layer">
        <button class="skip-btn" onclick="skipVideo()">SKIP >></button>
        <video id="gacha-video" playsinline></video>
    </div>

    <div id="reward-overlay">
        <div class="reward-title">‚ú® YOU GOT IT! ‚ú®</div>
        <div class="drop-box">
            <div class="glow-aura" id="glow-fx"></div>
            <img id="reward-img" src="" class="drop-img">
        </div>
        <div class="info-card">
            <h2 id="reward-name" style="margin: 0; color: var(--primary);">Name</h2>
            <p id="reward-rarity" style="margin: 5px 0 0 0; color: #888; font-weight: bold;">RARITY</p>
        </div>
        <button class="btn-claim" onclick="claimReward()">KEEP IT! üíñ</button>
    </div>

    <div id="main-ui" style="display: none;">
        <nav class="nav-bar">
            <div class="nav-item active" onclick="setPage('gacha')">üé∞</div>
            <div class="nav-item" onclick="setPage('market')">üè™</div>
            <div class="nav-item" onclick="setPage('donate')">üíñ</div>
            <div class="nav-item" onclick="setPage('profile')">üë§</div>
        </nav>

        <div id="page-gacha" class="page active">
            <h1>Choose a Treat!</h1>
            <div style="background: white; padding: 10px 30px; border-radius: 30px; margin-bottom: 20px; box-shadow: 0 5px 10px rgba(0,0,0,0.05);">
                <span style="color: var(--primary); font-weight: bold; font-size: 20px;">ü™ô <span id="ui-tokens">0</span> Tokens</span>
            </div>

            <div class="gacha-container">
                <div class="gacha-card" onclick="spin('icecream', 25)">
                    <div style="font-size: 60px;">üç¶</div>
                    <h3>Ice Cream</h3>
                    <div class="price-tag">25 TKN</div>
                </div>
                <div class="gacha-card" onclick="spin('milkshake', 50)">
                    <div style="font-size: 60px;">ü•§</div>
                    <h3>Milkshake</h3>
                    <div class="price-tag">50 TKN</div>
                </div>
                <div class="gacha-card" onclick="spin('cake', 100)">
                    <div style="font-size: 60px;">üéÇ</div>
                    <h3>Cake</h3>
                    <div class="price-tag">100 TKN</div>
                </div>
            </div>
        </div>

        <div id="page-market" class="page">
            <h1>üè™ Market</h1>
            <p>Scroll to see offers from others!</p>
            <div id="market-container" class="market-list"></div>
        </div>

        <div id="page-donate" class="page">
            <h1>Support Cafe ‚òï</h1>
            <div class="profile-header">
                <p>Donate ETH to build the Cafe!</p>
                <p><b>1 ETH = 1000 Tokens</b></p>
                <input type="number" id="donate-input" class="promo-input" placeholder="0.1" style="width: 150px; font-size: 18px;">
                <br><br>
                <button class="connect-mm" style="background: var(--primary);" onclick="donate()">DONATE</button>
            </div>
        </div>

        <div id="page-profile" class="page">
            <h1>My Profile üë§</h1>
            <div class="profile-header">
                <button class="connect-mm" onclick="connectWallet()">ü¶ä Connect MetaMask</button>
                <p id="wallet-address" style="font-size: 12px; display: none;">0x...</p>
                <div style="display: flex; justify-content: space-around; margin-top: 15px;">
                    <div><b>ETH:</b> <span id="ui-eth">0.00</span></div>
                    <div><b>TKN:</b> <span id="ui-tokens-p">0</span></div>
                </div>
                <div class="promo-area">
                    <p style="font-size: 12px; margin-bottom: 5px;">Secret Code:</p>
                    <div class="promo-container">
                        <input type="text" id="promo-code" class="promo-input" placeholder="Enter code">
                        <button class="promo-btn" onclick="applyPromo()">APPLY</button>
                    </div>
                    <div id="promo-status" class="promo-status">‚ú® Code Activated! ‚ú®</div>
                </div>
            </div>
            <h3>My Inventory</h3>
            <div id="inventory" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;"></div>
        </div>
    </div>

    <script>
        const TOKEN_ADDRESS = "0x5FbDB2315678afecb367f032d93F642f64180aa3"; 
        const CF_ADDRESS = "0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512";

        const CF_ABI = [
            "function contribute(uint256 _id) public payable",
            "function campaignCount() public view returns (uint256)",
            "function campaigns(uint256) public view returns (address owner, string title, uint256 goal, uint256 deadline, uint256 amountRaised, bool finalized)",
            "function createCampaign(string memory _title, uint256 _goal, uint256 _durationInDays) public"
        ];
        const TOKEN_ABI = [
            "function balanceOf(address) public view returns (uint256)",
            "function decimals() public view returns (uint8)"
        ];

        let provider, signer, cfContract, tokenContract;
        let userAddress = "";
        let tokens = 0; 
        let eth = 0;
        let inventory = [];
        let promoActive = null;

        const music = document.getElementById('bg-music');
        music.volume = 0.4;

        async function connectWallet() {
            if (window.ethereum) {
                try {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();
                    
                    cfContract = new ethers.Contract(CF_ADDRESS, CF_ABI, signer);
                    tokenContract = new ethers.Contract(TOKEN_ADDRESS, TOKEN_ABI, signer);

                    document.getElementById('wallet-address').innerText = userAddress.substring(0,6) + "..." + userAddress.substring(38);
                    document.getElementById('wallet-address').style.display = 'block';
                    document.querySelector('.connect-mm').innerText = "Connected ‚úÖ";
                    
                    await updateBalances(); 
                    checkAndCreateInitialCampaign();
                } catch (e) { alert("Connect error!"); }
            } else { alert("Install MetaMask!"); }
        }

        async function updateBalances() {
            if (!userAddress || !tokenContract) return;
            try {
                const rawEthBalance = await provider.getBalance(userAddress);
                const ethFormatted = ethers.utils.formatEther(rawEthBalance);
                document.getElementById('ui-eth').innerText = parseFloat(ethFormatted).toFixed(4);

                const rawTokenBalance = await tokenContract.balanceOf(userAddress);
                const tokensFormatted = ethers.utils.formatUnits(rawTokenBalance, 18);
                
                tokens = Math.floor(parseFloat(tokensFormatted));
                document.querySelectorAll('#ui-tokens, #ui-tokens-p').forEach(el => el.innerText = tokens);
                
                console.log("Balances updated:", ethFormatted, tokens);
            } catch (err) {
                console.error("Critical balance error:", err);
            }
        }
        async function donate() {
            const val = document.getElementById('donate-input').value;
            if (!val || val <= 0) return alert("Enter amount!");
            if (!cfContract) return alert("Connect MetaMask first!");

            try {
                const tx = await cfContract.contribute(0, { 
                    value: ethers.utils.parseEther(val) 
                });
                alert("Transaction sent! Wait...");
                await tx.wait(); 
                alert("Success! You got KITTY tokens!");
                await updateBalances();
            } catch (e) { alert("Error: " + e.message); }
        }

        async function checkAndCreateInitialCampaign() {
            const count = await cfContract.campaignCount();
            if (count == 0) {
                const tx = await cfContract.createCampaign("Main Cafe Opening", ethers.utils.parseEther("10"), 30);
                await tx.wait();
            }
        }

        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('main-ui').style.display = 'block';
            music.play();
        }

        function setPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('page-' + id).classList.add('active');
            const map = ['gacha', 'market', 'donate', 'profile'];
            document.querySelectorAll('.nav-item')[map.indexOf(id)].classList.add('active');
        }

        const rarities = {
            common: { color: "#a0aec0", name: "Common" },
            rare: { color: "#63b3ed", name: "Rare" },
            epic: { color: "#9f7aea", name: "Epic" },
            legendary: { color: "#f6e05e", name: "Legendary" },
            mythic: { color: "#f56565", name: "MYTHIC" }
        };

        const gachaConfig = {
            icecream: { video: "icecream_spin.mp4", prefix: "icecream" },
            milkshake: { video: "milkshake_spin.mp4", prefix: "milkshake" },
            cake: { video: "cake_spin.mp4", prefix: "cake" }
        };

        function spin(type, cost) {
            if (tokens < cost) return alert("Not enough $KITTY tokens! Go to Donate page.");
            
            tokens -= cost;
            document.querySelectorAll('#ui-tokens, #ui-tokens-p').forEach(el => el.innerText = tokens);

            document.getElementById('main-ui').style.display = 'none';
            music.volume = 0.1;

            let rKey = 'common';
            const rand = Math.random() * 100;
            if(rand > 60) rKey = 'rare';
            if(rand > 85) rKey = 'epic';
            if(rand > 98) rKey = 'legendary';
            if(rand > 99.5) rKey = 'mythic';

            const config = gachaConfig[type];
            currentReward = { type: type, name: "Cafe Special", rarity: rKey, image: `${config.prefix}_${rKey}.png` };

            const videoLayer = document.getElementById('video-layer');
            const video = document.getElementById('gacha-video');
            videoLayer.style.display = 'block';
            video.src = config.video;
            video.play();
            video.onended = showReward;
        }

        function showReward() {
            const overlay = document.getElementById('reward-overlay');
            const rData = rarities[currentReward.rarity];
            document.getElementById('reward-name').innerText = currentReward.name;
            document.getElementById('reward-rarity').innerText = rData.name;
            document.getElementById('reward-rarity').style.color = rData.color;
            document.getElementById('reward-img').src = currentReward.image;
            document.getElementById('glow-fx').style.background = `radial-gradient(circle, ${rData.color} 0%, transparent 70%)`;
            overlay.style.display = 'flex';
            setTimeout(() => overlay.classList.add('show'), 10);
        }

        function claimReward() {
            document.getElementById('reward-overlay').classList.remove('show');
            setTimeout(() => {
                document.getElementById('reward-overlay').style.display = 'none';
                document.getElementById('video-layer').style.display = 'none';
                document.getElementById('main-ui').style.display = 'block';
                music.volume = 0.4;
                inventory.push(currentReward);
                renderInventory();
            }, 300);
        }

        function renderInventory() {
            const box = document.getElementById('inventory');
            box.innerHTML = "";
            inventory.forEach(item => {
                const color = rarities[item.rarity].color;
                box.innerHTML += `<div style="width:60px; height:60px; border:2px solid ${color}; border-radius:10px; display:flex; align-items:center; justify-content:center; background:white; margin:5px;"><img src="${item.image}" style="width:40px;"></div>`;
            });
        }
    </script>
</body>
</html>